{% extends "modern/base.html" %}

{% block title %}Dashboard - Intellectia Trading Platform{% endblock %}

{% block extra_css %}
<style>
    .trading-view-widget {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        height: 500px;
    }

    .strategy-block {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }

    .strategy-block:hover {
        border-color: var(--accent-blue);
        transform: translateY(-1px);
    }

    .strategy-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .mini-widget {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .mini-widget:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .mini-widget-value {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .mini-widget-label {
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .alert-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--accent-red);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .ai-status-card {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
        color: white;
        border: none;
    }

    .symbol-selector {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 15px;
    }

    .retraining-timer {
        background: rgba(79, 139, 255, 0.1);
        border: 1px solid var(--accent-blue);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        text-align: center;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-white mb-3">Trading Dashboard</h2>
        <p class="text-secondary">Real-time portfolio monitoring and strategy management</p>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card fade-in pulse-glow glow-border" style="animation-delay: 0.1s;">
            <div class="metric-value gradient-text" id="portfolioValue">
                <div class="loading shimmer"></div>
            </div>
            <div class="metric-label">Portfolio Value</div>
            <div class="metric-change positive" id="portfolioChange">
                +0.00% (24h)
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card ai-status-card glass-effect scale-in" style="animation-delay: 0.2s;">
            <div class="metric-value gradient-text" id="aiAccuracy">
                <div class="loading shimmer"></div>
            </div>
            <div class="metric-label">AI Model Accuracy</div>
            <div class="retraining-timer glass-effect" id="retrainingTimer">
                <i class="fas fa-brain"></i> Next training: 2h 15m
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card slide-up" style="animation-delay: 0.3s;">
            <div class="metric-value gradient-text" id="winRate">
                <div class="loading shimmer"></div>
            </div>
            <div class="metric-label">Strategy Win Rate</div>
            <div class="metric-change neutral" id="totalTrades">
                <i class="fas fa-chart-line"></i> 0 trades today
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card rotate-in" style="animation-delay: 0.4s;">
            <div class="metric-value gradient-text" id="marketVolatility">
                <div class="loading shimmer"></div>
            </div>
            <div class="metric-label">Market Volatility</div>
            <div class="metric-change" id="volatilityChange">
                <i class="fas fa-wave-square"></i> Calculating...
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row mb-4">
    <!-- TradingView Chart -->
    <div class="col-lg-8 mb-4">
        <div class="trading-view-widget glass-effect fade-in floating">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 gradient-text">Market Analysis</h5>
                <select class="symbol-selector glass-effect" id="symbolSelector" onchange="updateChart()">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="BNBUSDT">BNB/USDT</option>
                    <option value="ADAUSDT">ADA/USDT</option>
                    <option value="SOLUSDT">SOL/USDT</option>
                </select>
            </div>
            <div id="tradingViewChart" style="height: 400px; border-radius: 12px; overflow: hidden;"></div>
        </div>
    </div>

    <!-- Strategy Builder Preview -->
    <div class="col-lg-4 mb-4">
        <div class="metric-card glass-effect slide-in">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 gradient-text">Active Strategies</h5>
                <a href="/strategy-builder" class="btn btn-primary btn-sm scale-in">Build Strategy</a>
            </div>

            <div class="strategy-block">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="strategy-indicator" style="background: var(--accent-green);"></span>
                        <strong>ATR Momentum</strong>
                    </div>
                    <span class="badge bg-success">Active</span>
                </div>
                <div class="mt-2 text-secondary small">
                    Entry: ATR > 0.15 | TP: 2.5% | SL: 1.2%
                </div>
                <div class="mt-2">
                    <span class="text-success">+12.5%</span> (7 days)
                </div>
            </div>

            <div class="strategy-block">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="strategy-indicator" style="background: var(--accent-blue);"></span>
                        <strong>Volume Breakout</strong>
                    </div>
                    <span class="badge bg-primary">Testing</span>
                </div>
                <div class="mt-2 text-secondary small">
                    Volume > 1.5x avg | RSI < 30
                </div>
                <div class="mt-2">
                    <span class="text-warning">+3.2%</span> (simulation)
                </div>
            </div>

            <div class="strategy-block">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="strategy-indicator" style="background: var(--text-secondary);"></span>
                        <strong>Mean Reversion</strong>
                    </div>
                    <span class="badge bg-secondary">Paused</span>
                </div>
                <div class="mt-2 text-secondary small">
                    BB lower + RSI oversold
                </div>
                <div class="mt-2">
                    <span class="text-danger">-1.8%</span> (last week)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mini Widgets Row -->
<div class="row mb-4">
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="mini-widget">
            <div class="mini-widget-value text-primary" id="openTrades">0</div>
            <div class="mini-widget-label">Open Trades</div>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="mini-widget">
            <div class="mini-widget-value text-success" id="todayProfit">$0</div>
            <div class="mini-widget-label">Today's P&L</div>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="mini-widget">
            <div class="mini-widget-value text-warning" id="exposure">0%</div>
            <div class="mini-widget-label">Total Exposure</div>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="mini-widget">
            <div class="mini-widget-value text-info" id="avgEntry">$0</div>
            <div class="mini-widget-label">Avg Entry</div>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="mini-widget position-relative">
            <div class="mini-widget-value text-danger" id="alerts">0</div>
            <div class="mini-widget-label">Active Alerts</div>
            <div class="alert-badge" id="alertBadge" style="display: none;">!</div>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="mini-widget">
            <div class="mini-widget-value" id="riskScore">
                <span class="text-success">Low</span>
            </div>
            <div class="mini-widget-label">Risk Level</div>
        </div>
    </div>
</div>

<!-- Portfolio Holdings -->
<div class="row">
    <div class="col-12">
        <div class="modern-table">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h5 class="mb-0">Portfolio Holdings</h5>
                <a href="/portfolio" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Quantity</th>
                        <th>Current Price</th>
                        <th>Value</th>
                        <th>24h Change</th>
                        <th>Allocation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="portfolioHoldings">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="loading"></div>
                            <div class="mt-2">Loading portfolio data...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/fetch-error-handler.js"></script>
<script src="/static/js/visual-enhancements.js"></script>
<script>
    let dashboardData = {};
    let chartData = {};
    let initializationAttempts = 0;
    const maxInitAttempts = 3;

    // Enhanced Dashboard Initialization with Error Recovery
    async function initializeDashboard() {
        updateSystemStatus('loading');
        initializationAttempts++;

        try {
            // Initialize with error handling
            await Promise.all([
                loadDashboardDataSafely(),
                initializeTradingViewChartSafely()
            ]);

            updateSystemStatus('live');
            updateLastUpdateTime();
            
            // Reset attempt counter on success
            initializationAttempts = 0;

            // Set up auto-refresh with error handling
            setInterval(async () => {
                try {
                    await loadDashboardDataSafely();
                } catch (error) {
                    console.warn('Auto-refresh error:', error);
                    // Continue running but show warning
                    updateSystemStatus('delay', 'Refresh delayed');
                }
            }, 30000);

        } catch (error) {
            console.error('Dashboard initialization error:', error);
            updateSystemStatus('error', error.message);
            
            // Retry initialization if under limit
            if (initializationAttempts < maxInitAttempts) {
                console.log(`Retrying initialization (attempt ${initializationAttempts + 1}/${maxInitAttempts})`);
                setTimeout(() => initializeDashboard(), 2000);
            } else {
                // Load with fallback data
                loadFallbackData();
            }
        }
    }

    // Safe data loading with enhanced error handling
    async function loadDashboardDataSafely() {
        try {
            const result = await window.fetchManager.safeFetch('/api/dashboard-data');
            
            if (result.success) {
                dashboardData = result.data;
                updateMetricsSafely();
                updatePortfolioTableSafely();
                updateMiniWidgetsSafely();
            } else {
                console.warn('Using fallback dashboard data');
                dashboardData = result.fallback || getDefaultDashboardData();
                updateMetricsSafely();
                updatePortfolioTableSafely();
                updateMiniWidgetsSafely();
                
                // Show user-friendly message
                showTemporaryNotification('Using cached data - some information may be delayed', 'info');
            }

        } catch (error) {
            console.error('Dashboard data error:', error);
            await window.fetchManager.recoverFromError(error, 'dashboard data loading');
            
            // Load fallback data
            loadFallbackData();
        }
    }

    function loadFallbackData() {
        dashboardData = getDefaultDashboardData();
        updateMetricsSafely();
        updatePortfolioTableSafely();
        updateMiniWidgetsSafely();
        updateSystemStatus('delay', 'Using cached data');
        
        showTemporaryNotification('Dashboard loaded with cached data. Live data will resume shortly.', 'warning');
    }

    function getDefaultDashboardData() {
        return {
            portfolio: {
                total_value: 156.92,
                daily_pnl: 0.0,
                daily_pnl_amount: 0.0,
                positions: [
                    {
                        symbol: 'PI',
                        quantity: 89.26,
                        avg_price: 1.75,
                        current_value: 156.06,
                        unrealized_pnl: 0.0,
                        allocation_pct: 99.4
                    }
                ]
            },
            ai_performance: {
                overall_accuracy: 78.5,
                win_rate: 71.8,
                total_predictions: 247
            },
            risk_metrics: {
                volatility: 0.157,
                risk_level: 'Medium'
            }
        };
    }

    // Load Dashboard Data
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/dashboard-data');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            dashboardData = await response.json();

            if (dashboardData.error) {
                throw new Error(dashboardData.error);
            }

            updateMetrics();
            updatePortfolioTable();
            updateMiniWidgets();

        } catch (error) {
            console.error('Dashboard data error:', error);
            updateSystemStatus('error', error.message);
            // Prevent unhandled rejection
            return Promise.resolve();
        }
    }

    // Safe metric updates with error handling
    function updateMetricsSafely() {
        try {
            const portfolio = dashboardData.portfolio || {};
            const ai = dashboardData.ai_performance || {};
            const risk = dashboardData.risk_metrics || {};

            // Portfolio Value with safe updates
            const portfolioValue = portfolio.total_value || 0;
            const dailyPnl = portfolio.daily_pnl || 0;
            
            window.fetchManager.safeUpdateUI('portfolioValue', `$${portfolioValue.toLocaleString()}`, 'Loading...');

            const changeEl = document.getElementById('portfolioChange');
            if (changeEl) {
                changeEl.textContent = `${dailyPnl > 0 ? '+' : ''}${dailyPnl.toFixed(2)}% (24h)`;
                changeEl.className = `metric-change ${dailyPnl >= 0 ? 'positive' : 'negative'}`;
            }

            // AI Accuracy with animation
            const accuracy = ai.overall_accuracy || 0;
            animateValue('aiAccuracy', accuracy, '%', 1);

            // Win Rate with animation
            const winRate = ai.win_rate || 0;
            animateValue('winRate', winRate, '%', 1);
            window.fetchManager.safeUpdateUI('totalTrades', `${ai.total_predictions || 0} predictions today`, '0 predictions');

            // Market Volatility
            const volatility = risk.volatility || 0;
            animateValue('marketVolatility', volatility * 100, '%', 1);

            const volChangeEl = document.getElementById('volatilityChange');
            if (volChangeEl) {
                volChangeEl.textContent = volatility > 0.25 ? 'High' : volatility > 0.15 ? 'Medium' : 'Low';
                volChangeEl.className = `metric-change ${volatility > 0.25 ? 'negative' : volatility > 0.15 ? 'neutral' : 'positive'}`;
            }

            // Add subtle success animation
            addUpdateAnimation();
            
        } catch (error) {
            console.error('Error updating metrics:', error);
            showTemporaryNotification('Some metrics may be outdated', 'warning');
        }
    }

    // Animate numeric values for better UX
    function animateValue(elementId, targetValue, suffix = '', decimals = 0) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const startValue = 0;
        const duration = 1000;
        const startTime = performance.now();

        function updateValue(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function for smooth animation
            const easedProgress = 1 - Math.pow(1 - progress, 3);
            const currentValue = startValue + (targetValue - startValue) * easedProgress;
            
            element.textContent = `${currentValue.toFixed(decimals)}${suffix}`;
            
            if (progress < 1) {
                requestAnimationFrame(updateValue);
            }
        }
        
        requestAnimationFrame(updateValue);
    }

    // Add visual feedback for updates
    function addUpdateAnimation() {
        const metrics = document.querySelectorAll('.metric-card');
        metrics.forEach((metric, index) => {
            setTimeout(() => {
                metric.style.transform = 'scale(1.02)';
                metric.style.boxShadow = '0 8px 32px rgba(59, 130, 246, 0.3)';
                
                setTimeout(() => {
                    metric.style.transform = '';
                    metric.style.boxShadow = '';
                }, 200);
            }, index * 100);
        });
    }

    // Enhanced notification system
    function showTemporaryNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Add notification styles if not exist
        if (!document.querySelector('#notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                .notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    min-width: 300px;
                    border-radius: 12px;
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    animation: slideInRight 0.3s ease-out;
                }
                
                .notification-info {
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(99, 102, 241, 0.8));
                    color: white;
                }
                
                .notification-warning {
                    background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.8));
                    color: white;
                }
                
                .notification-error {
                    background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.8));
                    color: white;
                }
                
                .notification-content {
                    padding: 16px 20px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .notification-close {
                    background: none;
                    border: none;
                    color: inherit;
                    cursor: pointer;
                    padding: 4px;
                    border-radius: 4px;
                    transition: background-color 0.2s;
                    margin-left: auto;
                }
                
                .notification-close:hover {
                    background-color: rgba(255, 255, 255, 0.2);
                }
                
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }

    // Safe Portfolio Table Update
    function updatePortfolioTableSafely() {
        try {
            const tbody = document.getElementById('portfolioHoldings');
            if (!tbody) {
                console.warn('Portfolio table element not found');
                return;
            }

            const positions = dashboardData.portfolio?.positions || [];

            if (positions.length === 0) {
                tbody.innerHTML = `
                    <tr class="fade-in">
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-wallet fa-3x text-secondary mb-3" style="opacity: 0.6;"></i>
                                <div class="mb-2" style="font-size: 1.1rem; font-weight: 600;">No positions found</div>
                                <small class="text-secondary">Portfolio data will appear here when available</small>
                                <div class="mt-3">
                                    <button class="btn btn-primary btn-sm" onclick="refreshPortfolio()">
                                        <i class="fas fa-refresh me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = positions.slice(0, 5).map((position, index) => {
                const changeClass = position.unrealized_pnl >= 0 ? 'text-success' : 'text-danger';
                const changeSign = position.unrealized_pnl >= 0 ? '+' : '';
                const animationDelay = index * 0.1;

                return `
                    <tr class="portfolio-row fade-in" style="animation-delay: ${animationDelay}s;">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="symbol-icon me-2">
                                    <div class="symbol-badge">${position.symbol.substring(0, 2)}</div>
                                </div>
                                <div>
                                    <div class="fw-bold">${position.symbol}</div>
                                    <small class="text-secondary">Spot</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="fw-semibold">${position.quantity.toFixed(6)}</span>
                        </td>
                        <td>
                            <span class="price-value">$${position.avg_price.toFixed(2)}</span>
                        </td>
                        <td>
                            <span class="value-highlight">$${position.current_value.toLocaleString()}</span>
                        </td>
                        <td>
                            <span class="pnl-badge ${changeClass}">
                                ${changeSign}${(position.unrealized_pnl).toFixed(2)}%
                            </span>
                        </td>
                        <td>
                            <div class="allocation-bar">
                                <div class="allocation-fill" style="width: ${position.allocation_pct}%"></div>
                                <span class="allocation-text">${position.allocation_pct.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="tradeAsset('${position.symbol}')">
                                    <i class="fas fa-exchange-alt me-1"></i>Trade
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewAssetInfo('${position.symbol}')">
                                    <i class="fas fa-info-circle me-1"></i>Info
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Add enhanced styling for portfolio table
            addPortfolioTableStyles();

        } catch (error) {
            console.error('Error updating portfolio table:', error);
            const tbody = document.getElementById('portfolioHoldings');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 error-recovery">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <div>Error loading portfolio data</div>
                            <button class="btn btn-sm btn-primary mt-2" onclick="loadDashboardDataSafely()">
                                Retry
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
    }

    function addPortfolioTableStyles() {
        if (!document.querySelector('#portfolio-table-styles')) {
            const style = document.createElement('style');
            style.id = 'portfolio-table-styles';
            style.textContent = `
                .portfolio-row {
                    transition: all 0.3s ease;
                }
                
                .portfolio-row:hover {
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)) !important;
                    transform: scale(1.01);
                }
                
                .symbol-badge {
                    width: 32px;
                    height: 32px;
                    border-radius: 8px;
                    background: linear-gradient(135deg, var(--secondary-color), var(--purple-accent));
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 700;
                    font-size: 0.75rem;
                }
                
                .price-value, .value-highlight {
                    font-weight: 600;
                    font-family: 'JetBrains Mono', monospace;
                }
                
                .pnl-badge {
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-weight: 700;
                    font-size: 0.8rem;
                }
                
                .pnl-badge.text-success {
                    background: rgba(16, 185, 129, 0.15);
                    color: #10b981;
                }
                
                .pnl-badge.text-danger {
                    background: rgba(239, 68, 68, 0.15);
                    color: #ef4444;
                }
                
                .allocation-bar {
                    position: relative;
                    height: 20px;
                    background: rgba(100, 116, 139, 0.2);
                    border-radius: 10px;
                    overflow: hidden;
                }
                
                .allocation-fill {
                    height: 100%;
                    background: linear-gradient(90deg, var(--secondary-color), var(--emerald-accent));
                    border-radius: 10px;
                    transition: width 1s ease-out;
                }
                
                .allocation-text {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 0.75rem;
                    font-weight: 600;
                    color: white;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
                }
                
                .action-buttons .btn {
                    transition: all 0.2s ease;
                }
                
                .action-buttons .btn:hover {
                    transform: translateY(-1px);
                }
                
                .empty-state {
                    padding: 2rem;
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Safe Mini Widgets Update
    function updateMiniWidgetsSafely() {
        try {
            const portfolio = dashboardData.portfolio || {};
            const positions = portfolio.positions || [];

            // Open Trades with animation
            animateValue('openTrades', positions.length, '', 0);

            // Today's P&L
            const dailyPnlAmount = portfolio.daily_pnl_amount || 0;
            const profitEl = document.getElementById('todayProfit');
            if (profitEl) {
                profitEl.textContent = `$${dailyPnlAmount.toFixed(2)}`;
                profitEl.className = `mini-widget-value ${dailyPnlAmount >= 0 ? 'text-success' : 'text-danger'}`;
            }

            // Total Exposure
            const totalExposure = positions.reduce((sum, pos) => sum + (pos.allocation_pct || 0), 0);
            animateValue('exposure', totalExposure, '%', 1);

            // Average Entry
            const totalValue = positions.reduce((sum, pos) => sum + (pos.current_value || 0), 0);
            const avgEntry = positions.length > 0 ? totalValue / positions.length : 0;
            window.fetchManager.safeUpdateUI('avgEntry', `$${avgEntry.toFixed(2)}`, '$0.00');

            // Alerts (placeholder)
            const alertCount = 0;
            window.fetchManager.safeUpdateUI('alerts', alertCount.toString(), '0');
            const alertBadge = document.getElementById('alertBadge');
            if (alertBadge) {
                alertBadge.style.display = alertCount > 0 ? 'flex' : 'none';
            }

            // Risk Score
            const riskLevel = dashboardData.risk_metrics?.risk_level || 'Low';
            const riskEl = document.getElementById('riskScore');
            if (riskEl) {
                const colorClass = riskLevel === 'High' ? 'text-danger' : riskLevel === 'Medium' ? 'text-warning' : 'text-success';
                riskEl.innerHTML = `<span class="${colorClass}">${riskLevel}</span>`;
            }

        } catch (error) {
            console.error('Error updating mini widgets:', error);
            showTemporaryNotification('Some dashboard widgets may show outdated information', 'warning');
        }
    }

    // Helper functions for portfolio actions
    function refreshPortfolio() {
        showTemporaryNotification('Refreshing portfolio data...', 'info');
        loadDashboardDataSafely();
    }

    function tradeAsset(symbol) {
        showTemporaryNotification(`Opening trade interface for ${symbol}...`, 'info');
        // Implement trade interface
    }

    function viewAssetInfo(symbol) {
        showTemporaryNotification(`Loading ${symbol} information...`, 'info');
        // Implement asset info modal
    }

    // Update Mini Widgets
    function updateMiniWidgets() {
        const portfolio = dashboardData.portfolio || {};
        const positions = portfolio.positions || [];

        // Open Trades
        document.getElementById('openTrades').textContent = positions.length;

        // Today's P&L
        const dailyPnlAmount = portfolio.daily_pnl_amount || 0;
        const profitEl = document.getElementById('todayProfit');
        profitEl.textContent = `$${dailyPnlAmount.toFixed(2)}`;
        profitEl.className = `mini-widget-value ${dailyPnlAmount >= 0 ? 'text-success' : 'text-danger'}`;

        // Total Exposure
        const totalExposure = positions.reduce((sum, pos) => sum + pos.allocation_pct, 0);
        document.getElementById('exposure').textContent = `${totalExposure.toFixed(1)}%`;

        // Average Entry
        const totalValue = positions.reduce((sum, pos) => sum + pos.current_value, 0);
        const avgEntry = totalValue / positions.length || 0;
        document.getElementById('avgEntry').textContent = `$${avgEntry.toFixed(2)}`;

        // Alerts
        const alertCount = 0; // Would come from alerts API
        document.getElementById('alerts').textContent = alertCount;
        document.getElementById('alertBadge').style.display = alertCount > 0 ? 'flex' : 'none';

        // Risk Score
        const riskLevel = dashboardData.risk_metrics?.risk_level || 'Low';
        const riskEl = document.getElementById('riskScore');
        riskEl.innerHTML = `<span class="text-${riskLevel === 'High' ? 'danger' : riskLevel === 'Medium' ? 'warning' : 'success'}">${riskLevel}</span>`;
    }

    // Safe TradingView Chart Initialization
    async function initializeTradingViewChartSafely() {
        try {
            // Check if Plotly is available
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, using fallback chart');
                createFallbackChart();
                return;
            }

            const chartData = await getChartData();
            const trace = {
                x: chartData.map(d => d.x),
                open: chartData.map(d => d.open),
                high: chartData.map(d => d.high),
                low: chartData.map(d => d.low),
                close: chartData.map(d => d.close),
                type: 'candlestick',
                xaxis: 'x',
                yaxis: 'y',
                increasing: {line: {color: '#10b981'}},
                decreasing: {line: {color: '#ef4444'}},
                name: 'Price'
            };

            const layout = {
                dragmode: 'zoom',
                margin: {r: 20, t: 40, b: 60, l: 80},
                showlegend: false,
                xaxis: {
                    autorange: true,
                    domain: [0, 1],
                    type: 'linear',
                    title: 'Time',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    color: '#cbd5e1'
                },
                yaxis: {
                    autorange: true,
                    domain: [0, 1],
                    type: 'linear',
                    title: 'Price ($)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    color: '#cbd5e1'
                },
                plot_bgcolor: 'transparent',
                paper_bgcolor: 'transparent',
                font: {
                    color: '#ffffff',
                    family: 'Inter, sans-serif'
                },
                title: {
                    text: 'Live Market Data',
                    font: {size: 16, color: '#f8fafc'},
                    x: 0.1
                }
            };

            const config = {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                responsive: true
            };

            await Plotly.newPlot('tradingViewChart', [trace], layout, config);
            
            // Add chart update animation
            const chartContainer = document.getElementById('tradingViewChart');
            if (chartContainer) {
                chartContainer.style.opacity = '0';
                chartContainer.style.transform = 'scale(0.95)';
                chartContainer.style.transition = 'all 0.5s ease-out';
                
                setTimeout(() => {
                    chartContainer.style.opacity = '1';
                    chartContainer.style.transform = 'scale(1)';
                }, 100);
            }
            
        } catch (error) {
            console.error('TradingView chart initialization error:', error);
            createFallbackChart();
        }
    }

    async function getChartData() {
        try {
            // Try to get real market data
            const result = await window.fetchManager.safeFetch('/api/market-data/BTCUSDT');
            if (result.success && result.data.candles) {
                return result.data.candles.map((candle, index) => ({
                    x: index + 1,
                    open: parseFloat(candle[1]),
                    high: parseFloat(candle[2]),
                    low: parseFloat(candle[3]),
                    close: parseFloat(candle[4])
                }));
            }
        } catch (error) {
            console.warn('Using fallback chart data:', error);
        }

        // Fallback data with realistic variation
        const basePrice = 65000;
        return Array.from({length: 20}, (_, i) => {
            const variation = (Math.random() - 0.5) * 2000;
            const open = basePrice + variation;
            const close = open + (Math.random() - 0.5) * 1000;
            const high = Math.max(open, close) + Math.random() * 500;
            const low = Math.min(open, close) - Math.random() * 500;
            
            return {x: i + 1, open, high, low, close};
        });
    }

    function createFallbackChart() {
        const chartContainer = document.getElementById('tradingViewChart');
        if (chartContainer) {
            chartContainer.innerHTML = `
                <div class="fallback-chart">
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line fa-3x" style="color: #3b82f6; margin-bottom: 1rem;"></i>
                        <h4>Market Chart</h4>
                        <p>Chart temporarily unavailable</p>
                        <div class="price-ticker">
                            <span class="price">$65,247.82</span>
                            <span class="change positive">+2.4%</span>
                        </div>
                    </div>
                </div>
                <style>
                    .fallback-chart {
                        height: 400px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
                        border-radius: 12px;
                        border: 1px solid rgba(59, 130, 246, 0.2);
                    }
                    .chart-placeholder {
                        text-align: center;
                        color: #cbd5e1;
                    }
                    .price-ticker {
                        margin-top: 1rem;
                        padding: 0.5rem 1rem;
                        background: rgba(59, 130, 246, 0.2);
                        border-radius: 8px;
                        display: inline-block;
                    }
                    .price {
                        font-size: 1.2rem;
                        font-weight: 700;
                        margin-right: 0.5rem;
                    }
                    .change.positive {
                        color: #10b981;
                    }
                </style>
            `;
        }
    }

    // Update Chart Symbol
    async function updateChart() {
        const symbol = document.getElementById('symbolSelector').value;
        console.log('Updating chart for symbol:', symbol);
        // Would fetch new data for selected symbol
        // For now, just log the symbol change
    }

    // Enhanced initialization with comprehensive error handling
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Enhanced dashboard initializing...');
        
        // Set up error boundaries
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            if (e.error && e.error.message && e.error.message.includes('React')) {
                showTemporaryNotification('Interface error detected, attempting recovery...', 'warning');
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        });

        // Initialize dashboard with retry logic
        initializeDashboard().catch(error => {
            console.error('Failed to initialize dashboard:', error);
            showTemporaryNotification('Dashboard initialization failed. Using offline mode.', 'error');
            loadFallbackData();
        });

        // Add performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const loadTime = performance.now();
                    console.log(`Dashboard loaded in ${loadTime.toFixed(2)}ms`);
                    if (loadTime > 3000) {
                        showTemporaryNotification('Dashboard loaded slower than expected. Consider refreshing if performance issues persist.', 'warning');
                    }
                }, 0);
            });
        }

        // Set up visibility change handler for tab switching
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Refresh data when tab becomes visible again
                setTimeout(() => {
                    loadDashboardDataSafely();
                }, 1000);
            }
        });

        // Add keyboard shortcuts for power users
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        showTemporaryNotification('Refreshing dashboard data...', 'info');
                        loadDashboardDataSafely();
                        break;
                    case 'h':
                        e.preventDefault();
                        showTemporaryNotification('Keyboard shortcuts: Ctrl+R (refresh), Ctrl+H (help)', 'info');
                        break;
                }
            }
        });
    });
</script>
<script src="/static/js/portfolio-fix.js"></script>
    <script src="/static/js/websocket-fix.js"></script>
    <script src="/static/js/fetch-error-handler.js"></script>
    <script>
        // Override existing fetch calls with error handling
        async function loadSignals() {
            const result = await window.fetchManager.safeFetch('/api/signals');
            if (result.success) {
                updateSignalsDisplay(result.data);
            } else {
                updateSignalsDisplay(result.fallback);
                console.log('Using fallback signals data');
            }
        }

        async function loadPortfolio() {
            const result = await window.fetchManager.safeFetch('/api/portfolio');
            if (result.success) {
                updatePortfolioDisplay(result.data);
            } else {
                updatePortfolioDisplay(result.fallback);
                console.log('Using fallback portfolio data');
            }
        }

        async function loadActivePositions() {
            const result = await window.fetchManager.safeFetch('/api/trading/active-positions');
            if (result.success) {
                updatePositionsDisplay(result.data);
            } else {
                updatePositionsDisplay(result.fallback);
                console.log('Using fallback positions data');
            }
        }

        // Initialize error-handled data loading
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data with error handling
            loadSignals();
            loadPortfolio();
            loadActivePositions();

            // Set up periodic updates with error handling
            setInterval(loadSignals, 10000);
            setInterval(loadPortfolio, 8000);
            setInterval(loadActivePositions, 12000);
        });
    </script>
</body>
</html>